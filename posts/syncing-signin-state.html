<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="jsx-3743936066 jsx-2167767515">Syncing sign-in state – Blog – Tom Moor</title><link rel="shortcut icon" href="//www.gravatar.com/avatar/166e0b975c36bbe15caa65209940035c.png" class="jsx-3743936066 jsx-2167767515"/><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/base-min.css" class="jsx-3743936066 jsx-2167767515"/><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-min.css" class="jsx-3743936066 jsx-2167767515"/><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css" class="jsx-3743936066 jsx-2167767515"/><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" class="jsx-3743936066 jsx-2167767515"/><meta name="theme-color" content="#FFFFFF" class="jsx-3743936066 jsx-2167767515"/><meta name="viewport" content="width=device-width, initial-scale=1" class="jsx-3743936066 jsx-2167767515"/><meta name="referrer" content="origin" class="jsx-3743936066 jsx-2167767515"/><meta name="site_name" property="og:site_name" content="Tom Moor" class="jsx-3743936066 jsx-2167767515"/><meta name="type" property="og:type" content="website" class="jsx-3743936066 jsx-2167767515"/><meta name="title" property="og:title" content="Syncing sign-in state – Blog" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:card" content="summary" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:site" content="@tommoor" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:domain" content="tommoor.com" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:title" content="Syncing sign-in state – Blog" class="jsx-3743936066 jsx-2167767515"/><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.css" rel="stylesheet" class="jsx-3743936066 jsx-2167767515"/><meta name="next-head-count" content="18"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-715970c8028b8d8e1f64.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-c617d96353df8716a680.js" defer=""></script><script src="/_next/static/chunks/pages/_app-cdc4828ff8eff3992bf8.js" defer=""></script><script src="/_next/static/chunks/746-66d53be612b6ba6e4a01.js" defer=""></script><script src="/_next/static/chunks/605-05b193d3f94727107b4d.js" defer=""></script><script src="/_next/static/chunks/507-7ae5d7b004bc695011e7.js" defer=""></script><script src="/_next/static/chunks/42-7a1a0f2e5a4ed61704e2.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-5eae9665eb6cab5b3b6b.js" defer=""></script><script src="/_next/static/oOQKHqnLkBpg1Y7vI1OaW/_buildManifest.js" defer=""></script><script src="/_next/static/oOQKHqnLkBpg1Y7vI1OaW/_ssgManifest.js" defer=""></script><style id="__jsx-4159018833">a.jsx-4159018833{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:8px 0;margin:0 16px;color:rgba(0,0,0,0.75);-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;min-height:40px;border-bottom:2px solid transparent;font-weight:500;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;overflow:hidden;-webkit-transition:all 100ms ease-in-out;transition:all 100ms ease-in-out;}a.jsx-4159018833:hover{border-bottom:2px solid #328aff;color:#328aff;}</style><style id="__jsx-2216165645">nav.jsx-2216165645{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;}ul.jsx-2216165645{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style:none;margin:0;padding:0;}li.jsx-2216165645{display:block;position:relative;margin:0 0 0 16px;}li.jsx-2216165645:hover{cursor:pointer;}li.hidden-on-desktop.jsx-2216165645{display:none;}@media (max-width:48em){li.jsx-2216165645{margin:0 0 0 8px;}li.hidden-on-desktop.jsx-2216165645{display:block;}li.hidden-on-mobile.jsx-2216165645{display:none;}}</style><style id="__jsx-1568871464">.metadata.jsx-1568871464{font-family:Roboto Mono, Menlo, monospace;color:#5E6573;font-size:0.9em;margin-top:-1em;margin-bottom:2em;}.metadata.jsx-1568871464 a.jsx-1568871464{color:#5E6573;}.metadata.jsx-1568871464 a.jsx-1568871464:hover{color:#181A1B;-webkit-text-decoration:underline;text-decoration:underline;}</style><style id="__jsx-1234508262">.md.jsx-1234508262{font-size:1.1em;line-height:1.4;color:#181A1B;}.md.jsx-1234508262 blockquote{margin-left:0;margin-right:0;background-color:#f2f2f2;border-left:6px solid #f2f2f2;padding:15px 30px 15px 15px;font-style:italic;font-size:16px;}.md.jsx-1234508262 a:hover{-webkit-text-decoration:underline;text-decoration:underline;}.md.jsx-1234508262 blockquote p{margin:0;}.md.jsx-1234508262 img{display:block;max-width:100%;box-shadow:0 0 0 1px rgba(0,0,0,0.2);border-radius:8px;margin:2em auto;}.md.jsx-1234508262 img[title="@2x"]{zoom:50%;}.md.jsx-1234508262 code{font-size:15px;background:#f2f2f2;padding:2px 4px;border-radius:2px;}.md.jsx-1234508262 li{line-height:1.6;}.md.jsx-1234508262 h3{margin-top:1.5em;}</style><style id="__jsx-3743936066">header.jsx-3743936066{color:inherit;background:transparent;}.back.jsx-3743936066{position:relative;top:2px;}.header-left.jsx-3743936066,.header-right.jsx-3743936066{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:32px 0;}.header-right.jsx-3743936066{-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;}.with-header.jsx-3743936066{padding-bottom:1em;margin-bottom:2em;}.page.jsx-3743936066{min-height:calc(100vh - 300px);max-width:700px;margin:0 auto;}.content.jsx-3743936066{padding:0 32px 48px;}@media (max-width:48em){.content.jsx-3743936066{padding:0 16px;}.back-link.jsx-3743936066{display:none;}}</style><style id="__jsx-2167767515">@font-face{font-family:"HK Grotesk";src:url("/fonts/HKGrotesk-Light.eot") format("eot"), url("/fonts/HKGrotesk-Light.woff2") format("woff2"), url("/fonts/HKGrotesk-Light.woff") format("woff");font-weight:300;font-style:normal;}@font-face{font-family:"HK Grotesk";src:url("/fonts/HKGrotesk-Regular.eot") format("eot"), url("/fonts/HKGrotesk-Regular.woff2") format("woff2"), url("/fonts/HKGrotesk-Regular.woff") format("woff");font-weight:400;font-style:normal;}@font-face{font-family:"HK Grotesk";src:url("/fonts/HKGrotesk-Bold.eot") format("eot"), url("/fonts/HKGrotesk-Bold.woff2") format("woff2"), url("/fonts/HKGrotesk-Bold.woff") format("woff");font-weight:600;font-style:normal;}.container{max-width:1140px;width:90vw;margin:0 auto;}*{box-sizing:border-box;}html,button,input,select,textarea,.pure-g [class*="pure-u"]{color:#121212;font-family:-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;}html,body{padding:0;margin:0;line-height:1.6;}h1{font-size:2em;}h2{font-size:1.2em;margin-top:1.4em;}h1,h2,h3,h4,.pure-g h1[class*="pure-u"],.pure-g h2[class*="pure-u"],.pure-g h3[class*="pure-u"],.pure-g h4[class*="pure-u"]{font-family:"HK Grotesk";font-weight:600;line-height:1;}a{color:#328aff;-webkit-text-decoration:none;text-decoration:none;}p{line-height:1.4;}</style></head><body><div id="__next"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js" class="jsx-3743936066 jsx-2167767515"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js" class="jsx-3743936066 jsx-2167767515"></script><header class="jsx-3743936066 jsx-2167767515 "><div class="jsx-3743936066 jsx-2167767515 container"><div class="jsx-3743936066 jsx-2167767515 pure-g"><div class="jsx-3743936066 jsx-2167767515 pure-u-1-2 header-left"><div class="jsx-3743936066 jsx-2167767515 back-link"><a href="/posts" class="jsx-4159018833 "><span class="jsx-3743936066 jsx-2167767515 back">↩</span> Back</a></div></div><div class="jsx-3743936066 jsx-2167767515 pure-u-1-2 header-right"><nav role="navigation" class="jsx-2216165645"><ul class="jsx-2216165645"><li class="jsx-2216165645"><a href="/" class="jsx-4159018833 ">About</a></li><li class="jsx-2216165645"><a href="/posts" class="jsx-4159018833 ">Blog</a></li><li class="jsx-2216165645 hidden-on-mobile"><a href="/rss.xml" class="jsx-4159018833 ">RSS</a></li><li class="jsx-2216165645"><a href="https://www.twitter.com/tommoor" target="_blank" class="jsx-4159018833 ">Twitter</a></li></ul></nav></div></div></div></header><div class="jsx-3743936066 jsx-2167767515 page"><div class="jsx-3743936066 jsx-2167767515 content"><h1>Syncing sign-in state</h1><div class="jsx-1568871464 metadata"><time dateTime="2021-07-22T00:00:00.000Z" class="time">July 21st, 2021</time> </div><div class="jsx-1234508262 md"><p>While adding some client-side data caching in <a href="https://www.getoutline.com">Outline</a> this week I came across a nice detail that was added into the codebase a while ago and I had forgotten about – syncing sign-in state across tabs.</p>
<p>Because Outline is primarily for writing documents, we see a use case where users keep many Outline tabs open containing different docs. This makes maintaining a synchronized authentication state all the more important, it would not be a great experience to have stale auth that errors when you attempt to interact with a long-open tab.</p>
<p>Thankfully depending on your architecture this could be as simple as just a few lines of code…</p>
<p><img src="/images/syncing-state.gif" alt="Outline signin state"/></p>
<p>Outline is built using <a href="https://mobx.js.org/">MobX</a> for state management. Local client state is split into multiple stores in the app, for example <code>users</code>, <code>documents</code>, <code>auth</code>. The <a href="https://github.com/outline/outline/blob/main/app/stores/AuthStore.js">auth store</a> contains data related to authentication such as the current user and team – it also manages the persistence and subscriptions. There are essentially three parts to this feature:</p>
<ul>
<li>Syncing auth in MobX state to localStorage</li>
<li>Listening to localStorage changes</li>
<li>Updating local MobX state from received events</li>
</ul>
<h3>Syncing MobX to localStorage</h3>
<p>MobX has the concept of reactions; side effects that happen in response to changes in observed data. We use a handy MobX method, <a href="https://mobx.js.org/reactions.html#autorun">autorun</a> that runs an effect whenever any of it’s dependencies change in order to write state to localStorage.</p>
<pre><code class="language-javascript">autorun(() =&gt; {
  try {
    localStorage.setItem(AUTH_STORE, JSON.stringify(this.data));
  } catch (_) {
    // no-op Safari private mode
  }
});
</code></pre>
<h3>Listening to localStorage changes</h3>
<p>Within the constructor we subscribe to the lesser-known <code>storage</code> event on the window. The <a href="https://developer.mozilla.org/en-US/docs/Web/API/StorageEvent">StorageEvent</a> contains tons of useful information such as the <code>oldValue</code>, <code>newValue</code>, and the <code>key</code> that was changed, using this listener we can listen to localStorage changes <strong>in other tabs</strong> and react to them.</p>
<h3>Updating local MobX state from events</h3>
<p>We check that the changed key matches our key for persisting auth data, parse the newValue and then act to either logout the user if the data no longer contains a user object (signed out) or to update the local MobX state from the event if the tab is currently signed out. A slightly simplified version looks like…</p>
<pre><code class="language-javascript">window.addEventListener(&quot;storage&quot;, (event) =&gt; {
  if (event.key === AUTH_STORE) {
    const data = JSON.parse(event.newValue);

    // If we&#x27;re not signed in then hydrate from the received data, otherwise if
    // we are signed in and the received data contains no user then sign out
    if (this.authenticated) {
      if (data.user === null) {
        this.logout();
      }
    } else {
      this.data = data;
    }
  }
});
</code></pre>
<p>The end result is another one of those little details so subtle you probably wouldn’t have noticed unless this post was written but it helps make the entire application feel more solid!</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Syncing sign-in state","slug":"syncing-signin-state","date":"2021-07-22T00:00:00.000Z","tag":"","content":"\nWhile adding some client-side data caching in [Outline](https://www.getoutline.com) this week I came across a nice detail that was added into the codebase a while ago and I had forgotten about – syncing sign-in state across tabs.\n\nBecause Outline is primarily for writing documents, we see a use case where users keep many Outline tabs open containing different docs. This makes maintaining a synchronized authentication state all the more important, it would not be a great experience to have stale auth that errors when you attempt to interact with a long-open tab.\n\nThankfully depending on your architecture this could be as simple as just a few lines of code…\n\n![Outline signin state](/images/syncing-state.gif)\n\nOutline is built using [MobX](https://mobx.js.org/) for state management. Local client state is split into multiple stores in the app, for example `users`, `documents`, `auth`. The [auth store](https://github.com/outline/outline/blob/main/app/stores/AuthStore.js) contains data related to authentication such as the current user and team – it also manages the persistence and subscriptions. There are essentially three parts to this feature:\n\n\n* Syncing auth in MobX state to localStorage\n* Listening to localStorage changes\n* Updating local MobX state from received events\n\n\n### Syncing MobX to localStorage\n\nMobX has the concept of reactions; side effects that happen in response to changes in observed data. We use a handy MobX method, [autorun](https://mobx.js.org/reactions.html#autorun) that runs an effect whenever any of it’s dependencies change in order to write state to localStorage.\n\n\n```javascript\nautorun(() =\u003e {\n  try {\n    localStorage.setItem(AUTH_STORE, JSON.stringify(this.data));\n  } catch (_) {\n    // no-op Safari private mode\n  }\n});\n```\n\n### Listening to localStorage changes\n\nWithin the constructor we subscribe to the lesser-known `storage` event on the window. The [StorageEvent](https://developer.mozilla.org/en-US/docs/Web/API/StorageEvent) contains tons of useful information such as the `oldValue`, `newValue`, and the `key` that was changed, using this listener we can listen to localStorage changes **in other tabs** and react to them.\n\n### Updating local MobX state from events\n\nWe check that the changed key matches our key for persisting auth data, parse the newValue and then act to either logout the user if the data no longer contains a user object (signed out) or to update the local MobX state from the event if the tab is currently signed out. A slightly simplified version looks like…\n\n```javascript\nwindow.addEventListener(\"storage\", (event) =\u003e {\n  if (event.key === AUTH_STORE) {\n    const data = JSON.parse(event.newValue);\n\n    // If we're not signed in then hydrate from the received data, otherwise if\n    // we are signed in and the received data contains no user then sign out\n    if (this.authenticated) {\n      if (data.user === null) {\n        this.logout();\n      }\n    } else {\n      this.data = data;\n    }\n  }\n});\n```\n\nThe end result is another one of those little details so subtle you probably wouldn’t have noticed unless this post was written but it helps make the entire application feel more solid!"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["syncing-signin-state"]},"buildId":"oOQKHqnLkBpg1Y7vI1OaW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>