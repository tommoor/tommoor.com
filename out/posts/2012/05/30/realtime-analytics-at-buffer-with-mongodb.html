<!DOCTYPE html><html><head><meta charSet="utf-8"/><title class="jsx-3743936066 jsx-2167767515">Realtime Analytics at Buffer with MongoDB – Blog – Tom Moor</title><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/base-min.css" class="jsx-3743936066 jsx-2167767515"/><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-min.css" class="jsx-3743936066 jsx-2167767515"/><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css" class="jsx-3743936066 jsx-2167767515"/><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" class="jsx-3743936066 jsx-2167767515"/><link rel="me" href="https://subculture.chat/@tom" title="Mastodon" class="jsx-3743936066 jsx-2167767515"/><meta name="theme-color" content="#FFFFFF" class="jsx-3743936066 jsx-2167767515"/><meta name="viewport" content="width=device-width, initial-scale=1" class="jsx-3743936066 jsx-2167767515"/><meta name="referrer" content="origin" class="jsx-3743936066 jsx-2167767515"/><meta name="site_name" property="og:site_name" content="Tom Moor" class="jsx-3743936066 jsx-2167767515"/><meta name="type" property="og:type" content="website" class="jsx-3743936066 jsx-2167767515"/><meta name="title" property="og:title" content="Realtime Analytics at Buffer with MongoDB – Blog" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:card" content="summary" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:site" content="@tommoor" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:domain" content="tommoor.com" class="jsx-3743936066 jsx-2167767515"/><meta name="twitter:title" content="Realtime Analytics at Buffer with MongoDB – Blog" class="jsx-3743936066 jsx-2167767515"/><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.css" rel="stylesheet" class="jsx-3743936066 jsx-2167767515"/><meta name="next-head-count" content="18"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-715970c8028b8d8e1f64.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-c617d96353df8716a680.js" defer=""></script><script src="/_next/static/chunks/pages/_app-cdc4828ff8eff3992bf8.js" defer=""></script><script src="/_next/static/chunks/746-66d53be612b6ba6e4a01.js" defer=""></script><script src="/_next/static/chunks/605-05b193d3f94727107b4d.js" defer=""></script><script src="/_next/static/chunks/507-7ae5d7b004bc695011e7.js" defer=""></script><script src="/_next/static/chunks/42-52ae4b2004a83af5088b.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-5eae9665eb6cab5b3b6b.js" defer=""></script><script src="/_next/static/SlYLdUw91C4kIHhjgjdSU/_buildManifest.js" defer=""></script><script src="/_next/static/SlYLdUw91C4kIHhjgjdSU/_ssgManifest.js" defer=""></script><style id="__jsx-4159018833">a.jsx-4159018833{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:8px 0;margin:0 16px;color:rgba(0,0,0,0.75);-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;min-height:40px;border-bottom:2px solid transparent;font-weight:500;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;overflow:hidden;-webkit-transition:all 100ms ease-in-out;transition:all 100ms ease-in-out;}a.jsx-4159018833:hover{border-bottom:2px solid #328aff;color:#328aff;}</style><style id="__jsx-2216165645">nav.jsx-2216165645{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;}ul.jsx-2216165645{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style:none;margin:0;padding:0;}li.jsx-2216165645{display:block;position:relative;margin:0 0 0 16px;}li.jsx-2216165645:hover{cursor:pointer;}li.hidden-on-desktop.jsx-2216165645{display:none;}@media (max-width:48em){li.jsx-2216165645{margin:0 0 0 8px;}li.hidden-on-desktop.jsx-2216165645{display:block;}li.hidden-on-mobile.jsx-2216165645{display:none;}}</style><style id="__jsx-1568871464">.metadata.jsx-1568871464{font-family:Roboto Mono, Menlo, monospace;color:#5E6573;font-size:0.9em;margin-top:-1em;margin-bottom:2em;}.metadata.jsx-1568871464 a.jsx-1568871464{color:#5E6573;}.metadata.jsx-1568871464 a.jsx-1568871464:hover{color:#181A1B;-webkit-text-decoration:underline;text-decoration:underline;}</style><style id="__jsx-1234508262">.md.jsx-1234508262{font-size:1.1em;line-height:1.4;color:#181A1B;}.md.jsx-1234508262 blockquote{margin-left:0;margin-right:0;background-color:#f2f2f2;border-left:6px solid #f2f2f2;padding:15px 30px 15px 15px;font-style:italic;font-size:16px;}.md.jsx-1234508262 a:hover{-webkit-text-decoration:underline;text-decoration:underline;}.md.jsx-1234508262 blockquote p{margin:0;}.md.jsx-1234508262 img{display:block;max-width:100%;box-shadow:0 0 0 1px rgba(0,0,0,0.2);border-radius:8px;margin:2em auto;}.md.jsx-1234508262 img[title="@2x"]{zoom:50%;}.md.jsx-1234508262 code{font-size:15px;background:#f2f2f2;padding:2px 4px;border-radius:2px;}.md.jsx-1234508262 li{line-height:1.6;}.md.jsx-1234508262 h3{margin-top:1.5em;}</style><style id="__jsx-3743936066">header.jsx-3743936066{color:inherit;background:transparent;}.back.jsx-3743936066{position:relative;top:2px;}.header-left.jsx-3743936066,.header-right.jsx-3743936066{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:32px 0;}.header-right.jsx-3743936066{-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;}.with-header.jsx-3743936066{padding-bottom:1em;margin-bottom:2em;}.page.jsx-3743936066{min-height:calc(100vh - 300px);max-width:700px;margin:0 auto;}.content.jsx-3743936066{padding:0 32px 48px;}@media (max-width:48em){.content.jsx-3743936066{padding:0 16px;}.back-link.jsx-3743936066{display:none;}}</style><style id="__jsx-2167767515">@font-face{font-family:"HK Grotesk";src:url("/fonts/HKGrotesk-Light.eot") format("eot"), url("/fonts/HKGrotesk-Light.woff2") format("woff2"), url("/fonts/HKGrotesk-Light.woff") format("woff");font-weight:300;font-style:normal;}@font-face{font-family:"HK Grotesk";src:url("/fonts/HKGrotesk-Regular.eot") format("eot"), url("/fonts/HKGrotesk-Regular.woff2") format("woff2"), url("/fonts/HKGrotesk-Regular.woff") format("woff");font-weight:400;font-style:normal;}@font-face{font-family:"HK Grotesk";src:url("/fonts/HKGrotesk-Bold.eot") format("eot"), url("/fonts/HKGrotesk-Bold.woff2") format("woff2"), url("/fonts/HKGrotesk-Bold.woff") format("woff");font-weight:600;font-style:normal;}.container{max-width:1140px;width:90vw;margin:0 auto;}*{box-sizing:border-box;}html,button,input,select,textarea,.pure-g [class*="pure-u"]{color:#121212;font-family:-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;}html,body{padding:0;margin:0;line-height:1.6;}h1{font-size:2em;}h2{font-size:1.2em;margin-top:1.4em;}h1,h2,h3,h4,.pure-g h1[class*="pure-u"],.pure-g h2[class*="pure-u"],.pure-g h3[class*="pure-u"],.pure-g h4[class*="pure-u"]{font-family:"HK Grotesk";font-weight:600;line-height:1;}a{color:#328aff;-webkit-text-decoration:none;text-decoration:none;}p{line-height:1.4;}</style></head><body><div id="__next"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js" class="jsx-3743936066 jsx-2167767515"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js" class="jsx-3743936066 jsx-2167767515"></script><header class="jsx-3743936066 jsx-2167767515 "><div class="jsx-3743936066 jsx-2167767515 container"><div class="jsx-3743936066 jsx-2167767515 pure-g"><div class="jsx-3743936066 jsx-2167767515 pure-u-1-2 header-left"><div class="jsx-3743936066 jsx-2167767515 back-link"><a href="/posts" class="jsx-4159018833 "><span class="jsx-3743936066 jsx-2167767515 back">↩</span> Back</a></div></div><div class="jsx-3743936066 jsx-2167767515 pure-u-1-2 header-right"><nav role="navigation" class="jsx-2216165645"><ul class="jsx-2216165645"><li class="jsx-2216165645"><a href="/" class="jsx-4159018833 ">About</a></li><li class="jsx-2216165645"><a href="/posts" class="jsx-4159018833 ">Blog</a></li><li class="jsx-2216165645 hidden-on-mobile"><a href="/rss.xml" class="jsx-4159018833 ">RSS</a></li><li class="jsx-2216165645"><a href="https://www.twitter.com/tommoor" target="_blank" class="jsx-4159018833 ">Twitter</a></li></ul></nav></div></div></div></header><div class="jsx-3743936066 jsx-2167767515 page"><div class="jsx-3743936066 jsx-2167767515 content"><h1>Realtime Analytics at Buffer with MongoDB</h1><div class="jsx-1568871464 metadata"><time dateTime="2012-05-30T08:00:00.000Z" class="time">May 30th, 2012</time> </div><div class="jsx-1234508262 md"><p>At <a href="http://bufferapp.com">Buffer</a> we try our best to be a data-driven startup, it can be hard work measuring, testing, correctly reading the data and then acting on these results - we definitely still have a lot to learn. Currently we use a combination of third party tools such as <a href="http://kissmetrics.com">Kissmetrics</a> and <a href="http://www.google.com/analytics">Google Analytics</a> as well as our own hand-rolled metrics for internal data.</p>
<p>The area where we are most happy with our approach is in measuring internal statistics, for example how many people used the latest Firefox extension last week, or how many API requests to which endpoints were there in the last 2 hours or which website with the Buffer widget provided the most signups last week?</p>
<p><strong>To make informed product decisions we need to easily access and visualise key business data in realtime.</strong></p>
<h3>Using MongoDB to measure realtime stats</h3>
<p>Our current tool of choice is <a href="http://www.mongodb.org">MongoDB</a>, using a combination of <a href="http://www.mongodb.org/display/DOCS/Atomic+Operations">atomic ‘inc’ methods</a> and ‘unsafe’ saves we can update key metrics in the database blindingly fast with a negligible affect on performance of the front end (as the driver doesn’t wait for save success before continuing).</p>
<p>By storing these statistics in minutely, weekly or hourly batches we can also limit data growth to a predictable rate and increase read speeds in the admin area.</p>
<pre><code class="javascript">
    db.clients_by_time.update({
        &#x27;hour&#x27;: $hour,
        &#x27;client_id&#x27;: $client_id
    }, {
        &#x27;$inc&#x27; =&gt; array(
            &#x27;requests&#x27; =&gt; 1,
            &#x27;statuses.&#x27;.$status_code =&gt; 1,
            &#x27;endpoints.&#x27;.$endpoint =&gt; 1,
            &#x27;response_time&#x27; =&gt; round($response_time)
        )
    }, true);
</code>
</pre>
<p>The code snippet above is inspired by <a href="http://blog.mongodb.org/post/171353301/using-mongodb-for-real-time-analytics">this post</a> on the mongodb blog and is used to record the performance usage of Buffer API clients. It allows us to produce detailed graphs like the following in realtime and with upto the second data.</p>
<p><img src="http://media.tumblr.com/tumblr_m4qii3RgVa1qz7mjl.png" alt="Buffer API graph"/></p>
<p class="caption">A typical API client</p>
<p>Several individual values are incremented, one for the total requests as well as individual status codes and endpoints.</p>
<p>Sometimes tricks can be used to allow the use of incrementing values where you might not usually, for example in the above code ‘response_time’ is incremented with the response time of each API request - the value becomes the sum total of all API requests in the hour. It is then easy to calculate the average when we return the document by dividing by the total requests. To store the average in the document itself would require an extra query for every request and this is well worth avoiding!</p>
<p><img src="http://media.tumblr.com/tumblr_m4rw5fQ6ad1qz7mjl.png" alt="Buffer extensions graph"/></p>
<p class="caption">Buffer update sources</p>
<h3>Where to go from here</h3>
<p>We believe that this approach scales exceptionally well and it has certainly done us proud so far.</p>
<p>As the dataset grows it is inevitable that we will want to automate weekly, monthly and eventually yearly rollups and with only 168 documents created per collection, per week for data recorded hourly this is a task that can be easily performed in code rather than requiring map reduce.</p>
<p>By far the biggest area for improvement is in our display of all the data we are gathering. At the moment this is largely using simple line graphs with raw values over time (we don’t even have a way to go back to previous weeks yet!). Some of the analytics would also be much better expressed as percentages of a total, stacked graphs or one of the many other types of charts.</p>
<p><strong>Have any thoughts on our approach? Have you tackled things differently in your company? I would love to hear them in the comments.</strong></p>
<h3>Further Reading</h3>
<ul><li><a href="http://blog.mongodb.org/post/171353301/using-mongodb-for-real-time-analytics">Using MongoDB for Real-time Analytics</a> 
The original mongodb blog post that inspired this approach.</li>
<li><a href="http://www.slideshare.net/dacort/mongodb-realtime-data-collection-and-stats-generation">MongoDB Real-time Data Collection and Stats Generation</a></li>
<li><a href="http://blog.getspool.com/2011/11/29/fast-easy-realtime-metrics-using-redis-bitmaps/">Fast, easy, realtime metrics using Redis bitmaps</a>
Not a method we are currently using, but a very interesting approach to the problem solved using redis bitmaps.</li>
</ul></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Realtime Analytics at Buffer with MongoDB","slug":"2012/05/30/realtime-analytics-at-buffer-with-mongodb","date":"2012-05-30T08:00:00.000Z","tag":"","content":"\n\u003cp\u003eAt \u003ca href=\"http://bufferapp.com\"\u003eBuffer\u003c/a\u003e we try our best to be a data-driven startup, it can be hard work measuring, testing, correctly reading the data and then acting on these results - we definitely still have a lot to learn. Currently we use a combination of third party tools such as \u003ca href=\"http://kissmetrics.com\"\u003eKissmetrics\u003c/a\u003e and \u003ca href=\"http://www.google.com/analytics\"\u003eGoogle Analytics\u003c/a\u003e as well as our own hand-rolled metrics for internal data.\u003c/p\u003e\n\n\u003cp\u003eThe area where we are most happy with our approach is in measuring internal statistics, for example how many people used the latest Firefox extension last week, or how many API requests to which endpoints were there in the last 2 hours or which website with the Buffer widget provided the most signups last week?\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eTo make informed product decisions we need to easily access and visualise key business data in realtime.\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch3\u003eUsing MongoDB to measure realtime stats\u003c/h3\u003e\n\n\u003cp\u003eOur current tool of choice is \u003ca href=\"http://www.mongodb.org\"\u003eMongoDB\u003c/a\u003e, using a combination of \u003ca href=\"http://www.mongodb.org/display/DOCS/Atomic+Operations\"\u003eatomic \u0026#8216;inc\u0026#8217; methods\u003c/a\u003e and \u0026#8216;unsafe\u0026#8217; saves we can update key metrics in the database blindingly fast with a negligible affect on performance of the front end (as the driver doesn\u0026#8217;t wait for save success before continuing).\u003c/p\u003e\n\n\u003cp\u003eBy storing these statistics in minutely, weekly or hourly batches we can also limit data growth to a predictable rate and increase read speeds in the admin area.\u003c/p\u003e\n\n\u003cpre\u003e\n\u003ccode class=\"javascript\"\u003e\n    db.clients_by_time.update({\n        'hour': $hour,\n        'client_id': $client_id\n    }, {\n        '$inc' =\u0026gt; array(\n            'requests' =\u0026gt; 1,\n            'statuses.'.$status_code =\u0026gt; 1,\n            'endpoints.'.$endpoint =\u0026gt; 1,\n            'response_time' =\u0026gt; round($response_time)\n        )\n    }, true);\n\u003c/code\u003e\n\u003c/pre\u003e\n\n\u003cp\u003eThe code snippet above is inspired by \u003ca href=\"http://blog.mongodb.org/post/171353301/using-mongodb-for-real-time-analytics\"\u003ethis post\u003c/a\u003e on the mongodb blog and is used to record the performance usage of Buffer API clients. It allows us to produce detailed graphs like the following in realtime and with upto the second data.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"http://media.tumblr.com/tumblr_m4qii3RgVa1qz7mjl.png\" alt=\"Buffer API graph\"/\u003e\u003c/p\u003e\n\n\u003cp class=\"caption\"\u003eA typical API client\u003c/p\u003e\n\n\u003cp\u003eSeveral individual values are incremented, one for the total requests as well as individual status codes and endpoints.\u003c/p\u003e\n\n\u003cp\u003eSometimes tricks can be used to allow the use of incrementing values where you might not usually, for example in the above code \u0026#8216;response_time\u0026#8217; is incremented with the response time of each API request - the value becomes the sum total of all API requests in the hour. It is then easy to calculate the average when we return the document by dividing by the total requests. To store the average in the document itself would require an extra query for every request and this is well worth avoiding!\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"http://media.tumblr.com/tumblr_m4rw5fQ6ad1qz7mjl.png\" alt=\"Buffer extensions graph\"/\u003e\u003c/p\u003e\n\n\u003cp class=\"caption\"\u003eBuffer update sources\u003c/p\u003e\n\n\u003ch3\u003eWhere to go from here\u003c/h3\u003e\n\n\u003cp\u003eWe believe that this approach scales exceptionally well and it has certainly done us proud so far.\u003c/p\u003e\n\n\u003cp\u003eAs the dataset grows it is inevitable that we will want to automate weekly, monthly and eventually yearly rollups and with only 168 documents created per collection, per week for data recorded hourly this is a task that can be easily performed in code rather than requiring map reduce.\u003c/p\u003e\n\n\u003cp\u003eBy far the biggest area for improvement is in our display of all the data we are gathering. At the moment this is largely using simple line graphs with raw values over time (we don\u0026#8217;t even have a way to go back to previous weeks yet!). Some of the analytics would also be much better expressed as percentages of a total, stacked graphs or one of the many other types of charts.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eHave any thoughts on our approach? Have you tackled things differently in your company? I would love to hear them in the comments.\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch3\u003eFurther Reading\u003c/h3\u003e\n\n\u003cul\u003e\u003cli\u003e\u003ca href=\"http://blog.mongodb.org/post/171353301/using-mongodb-for-real-time-analytics\"\u003eUsing MongoDB for Real-time Analytics\u003c/a\u003e \nThe original mongodb blog post that inspired this approach.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://www.slideshare.net/dacort/mongodb-realtime-data-collection-and-stats-generation\"\u003eMongoDB Real-time Data Collection and Stats Generation\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://blog.getspool.com/2011/11/29/fast-easy-realtime-metrics-using-redis-bitmaps/\"\u003eFast, easy, realtime metrics using Redis bitmaps\u003c/a\u003e\nNot a method we are currently using, but a very interesting approach to the problem solved using redis bitmaps.\u003c/li\u003e\n\u003c/ul\u003e"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2012","05","30","realtime-analytics-at-buffer-with-mongodb"]},"buildId":"SlYLdUw91C4kIHhjgjdSU","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>