{"pageProps":{"title":"Syncing sign-in state","slug":"syncing-signin-state","date":"2021-07-22T00:00:00.000Z","tag":"","content":"\nWhile adding some client-side data caching in [Outline](https://www.getoutline.com) this week I came across a nice detail that was added into the codebase a while ago and I had forgotten about – syncing sign-in state across tabs.\n\nBecause Outline is primarily for writing documents, we see a use case where users keep many Outline tabs open containing different docs. This makes maintaining a synchronized authentication state all the more important, it would not be a great experience to have stale auth that errors when you attempt to interact with a long-open tab.\n\nThankfully depending on your architecture this could be as simple as just a few lines of code…\n\n![Outline signin state](/images/syncing-state.gif)\n\nOutline is built using [MobX](https://mobx.js.org/) for state management. Local client state is split into multiple stores in the app, for example `users`, `documents`, `auth`. The [auth store](https://github.com/outline/outline/blob/main/app/stores/AuthStore.js) contains data related to authentication such as the current user and team – it also manages the persistence and subscriptions. There are essentially three parts to this feature:\n\n\n* Syncing auth in MobX state to localStorage\n* Listening to localStorage changes\n* Updating local MobX state from received events\n\n\n### Syncing MobX to localStorage\n\nMobX has the concept of reactions; side effects that happen in response to changes in observed data. We use a handy MobX method, [autorun](https://mobx.js.org/reactions.html#autorun) that runs an effect whenever any of it’s dependencies change in order to write state to localStorage.\n\n\n```javascript\nautorun(() => {\n  try {\n    localStorage.setItem(AUTH_STORE, JSON.stringify(this.data));\n  } catch (_) {\n    // no-op Safari private mode\n  }\n});\n```\n\n### Listening to localStorage changes\n\nWithin the constructor we subscribe to the lesser-known `storage` event on the window. The [StorageEvent](https://developer.mozilla.org/en-US/docs/Web/API/StorageEvent) contains tons of useful information such as the `oldValue`, `newValue`, and the `key` that was changed, using this listener we can listen to localStorage changes **in other tabs** and react to them.\n\n### Updating local MobX state from events\n\nWe check that the changed key matches our key for persisting auth data, parse the newValue and then act to either logout the user if the data no longer contains a user object (signed out) or to update the local MobX state from the event if the tab is currently signed out. A slightly simplified version looks like…\n\n```javascript\nwindow.addEventListener(\"storage\", (event) => {\n  if (event.key === AUTH_STORE) {\n    const data = JSON.parse(event.newValue);\n\n    // If we're not signed in then hydrate from the received data, otherwise if\n    // we are signed in and the received data contains no user then sign out\n    if (this.authenticated) {\n      if (data.user === null) {\n        this.logout();\n      }\n    } else {\n      this.data = data;\n    }\n  }\n});\n```\n\nThe end result is another one of those little details so subtle you probably wouldn’t have noticed unless this post was written but it helps make the entire application feel more solid!"},"__N_SSG":true}